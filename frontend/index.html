<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Alexandria Emergency Alert Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#001f3f;color:#fff;font-family:Arial, sans-serif;min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    .header{margin-bottom:40px}
    .header{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:20px}
    .header-content{flex:1}
    .header h1{font-size:2.5rem;margin-bottom:15px;font-weight:700}
    .header p{font-size:1rem;line-height:1.6;opacity:.9}
    .user-info{display:flex;align-items:center;gap:15px;background:rgba(255,255,255,.1);padding:12px 20px;border-radius:8px;backdrop-filter:blur(10px)}
    .user-info span{opacity:.9;font-size:.9rem}
    .logout-btn{padding:8px 16px;border-radius:6px;border:none;background:rgba(220,53,69,.3);color:#fff;cursor:pointer;font-size:.85rem;font-weight:600;transition:all .2s}
    .logout-btn:hover{background:rgba(220,53,69,.6);transform:translateY(-1px)}
    .dashboard{display:grid;grid-template-columns:2fr 1fr;gap:30px}
    .alerts-section h2,.urgency-section h2{font-size:1.8rem;margin-bottom:25px;font-weight:600}
    .alert-item{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border-radius:12px;padding:20px;margin-bottom:20px;border-left:5px solid;position:relative;transition:transform .2s ease, box-shadow .2s ease;display:flex;flex-direction:column;word-wrap:break-word;overflow-wrap:break-word}
    .alert-item:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(0,0,0,.2)}
    .alert-item.High{border-left-color:#dc3545;background:rgba(220,53,69,.1)}
    .alert-item.Medium{border-left-color:#fd7e14;background:rgba(253,126,20,.1)}
    .alert-item.Low{border-left-color:#ffc107;background:rgba(255,193,7,.1)}
    .alert-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:15px}
    .urgency-badge{padding:6px 14px;border-radius:20px;font-size:.8rem;font-weight:600;text-transform:capitalize}
    .urgency-badge.High{background:#dc3545}
    .urgency-badge.Medium{background:#fd7e14}
    .urgency-badge.Low{background:#ffc107;color:#333}
    .time-location{font-size:.9rem;opacity:.8;margin-bottom:8px}
    .alert-title{font-size:1.1rem;font-weight:600;line-height:1.4;margin-bottom:8px}
    .alert-summary{font-size:.95rem;opacity:.95;margin-bottom:10px}
    .source-chip{font-size:.8rem;opacity:.9;margin-top:6px;display:inline-flex;gap:8px;align-items:center}
    .source-chip a{color:#ffd76a;text-decoration:none}
    .action-section{margin-top:10px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .action-buttons{display:flex;gap:10px}
    .action-btn{padding:8px 16px;border-radius:6px;border:none;cursor:pointer;font-size:.85rem;transition:all .2s ease;font-weight:600}
    .action-btn:hover{transform:translateY(-1px)}
    .action-btn.view-more{background:#28a745;color:#fff}
    .action-btn.view-more:hover{background:#218838}
    .action-btn.not-relevant{background:rgba(220,53,69,.3);color:#fff}
    .action-btn.not-relevant:hover{background:rgba(220,53,69,.6)}
    .action-btn.view-map{background:#17a2b8;color:#fff}
    .action-btn.view-map:hover{background:#138496}
    .action-btn:disabled{opacity:.5;cursor:not-allowed}
    .alert-item.highlighted{box-shadow:0 0 20px rgba(255,215,106,0.6);border:2px solid #ffd76a;animation:pulseHighlight 2s ease-in-out}
    @keyframes pulseHighlight{0%,100%{box-shadow:0 0 20px rgba(255,215,106,0.6)}50%{box-shadow:0 0 30px rgba(255,215,106,0.9)}}
    .acknowledged-badge{background:rgba(40,167,69,.3);color:#90ee90;padding:4px 10px;border-radius:4px;font-size:.75rem;font-weight:600}
    .sidebar{display:flex;flex-direction:column;gap:30px}
    .urgency-panel{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border-radius:12px;padding:25px}
    .urgency-indicator{display:flex;flex-direction:column;gap:12px;margin-bottom:30px}
    .urgency-level{padding:12px 20px;border-radius:8px;text-align:center;font-weight:600;cursor:pointer;transition:all .2s ease;user-select:none}
    .urgency-level:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
    .urgency-level.active{box-shadow:0 0 0 3px rgba(255,215,106,0.5);border:2px solid #ffd76a}
    .urgency-level.High{background:#dc3545}
    .urgency-level.Medium{background:#fd7e14}
    .urgency-level.Low{background:#ffc107;color:#333}
    .source-list li{cursor:pointer;transition:all .2s ease;user-select:none}
    .source-list li:hover{background:rgba(255,255,255,.1);padding-left:8px}
    .source-list li.active{background:rgba(255,215,106,.2);border-left:3px solid #ffd76a;padding-left:12px}
    .provenance h3{margin-bottom:15px;font-size:1.2rem}
    .source-list{list-style:none}
    .source-list li{padding:8px 0;border-bottom:1px solid rgba(255,255,255,.1);font-size:.95rem}
    .source-list li:last-child{border-bottom:none}
    .loading{text-align:center;padding:40px;opacity:.7}
    .no-alerts{text-align:center;padding:40px;background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border-radius:12px;opacity:.8}
    .status-indicator{display:inline-block;width:12px;height:12px;background:#28a745;border-radius:50%;margin-right:8px;animation:pulse 2s infinite}
    @keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}
    .last-updated{text-align:right;font-size:.8rem;opacity:.7;margin-top:20px}
    
    /* Detail Modal */
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.7);animation:fadeIn .3s}
    .modal.active{display:block}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modal-content{background:#001f3f;margin:5% auto;padding:30px;border:1px solid rgba(255,255,255,.2);border-radius:12px;width:90%;max-width:800px;position:relative;animation:slideIn .3s}
    @keyframes slideIn{from{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}
    .close-modal{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer;line-height:20px}
    .close-modal:hover{color:#fff}
    .modal-header{margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid rgba(255,255,255,.2)}
    .modal-title{font-size:1.5rem;margin-bottom:10px}
    .modal-body{max-height:60vh;overflow-y:auto}
    .detail-section{margin-bottom:20px}
    .detail-section h3{font-size:1.1rem;margin-bottom:10px;color:#ffd76a}
    .detail-section p{line-height:1.6;opacity:.9}
    .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}
    .detail-item{background:rgba(255,255,255,.05);padding:12px;border-radius:6px}
    .detail-item label{display:block;font-size:.8rem;opacity:.7;margin-bottom:4px}
    .detail-item value{font-size:.95rem;font-weight:600}
    .raw-payload{background:rgba(0,0,0,.3);padding:15px;border-radius:6px;overflow-x:auto;font-family:monospace;font-size:.85rem;max-height:300px;overflow-y:auto}
    .acknowledge-form{margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,.2)}
    .acknowledge-form textarea{width:100%;padding:10px;border-radius:6px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;font-family:inherit;resize:vertical;min-height:80px}
    .acknowledge-form button{margin-top:10px;padding:10px 20px;border-radius:6px;border:none;background:#28a745;color:#fff;cursor:pointer;font-weight:600}
    .acknowledge-form button:hover{background:#218838}
    
    @media (max-width:768px){.dashboard{grid-template-columns:1fr;gap:20px}.header h1{font-size:2rem}.detail-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-content">
        <h1>Alexandria Emergency Alert Dashboard</h1>
        <p>Real-time emergency alert system integrating data from NWS, USGS, NASA, and WMATA with AI-powered criticality classification.</p>
        <div style="margin-top:20px;display:flex;gap:10px">
          <a href="index.html" style="padding:10px 20px;border-radius:6px;background:rgba(255,255,255,.1);color:#fff;text-decoration:none;font-weight:600;transition:all .2s">
            <i class="fas fa-list"></i> List View
          </a>
          <a href="map.html" style="padding:10px 20px;border-radius:6px;background:#28a745;color:#fff;text-decoration:none;font-weight:600;transition:all .2s">
            <i class="fas fa-map"></i> Map View
          </a>
        </div>
      </div>
      <div class="user-info" id="user-info">
        <span id="user-display">Loading...</span>
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>

    <div class="dashboard">
      <div class="alerts-section">
        <h2><span class="status-indicator"></span>Alerts</h2>
        <div id="alerts-container"><div class="loading">Loading emergency alerts...</div></div>
        <div class="last-updated" id="last-updated"></div>
      </div>

      <div class="sidebar">
        <div class="urgency-panel">
          <h2>Criticality</h2>
          <div class="urgency-indicator">
            <div class="urgency-level High" id="filter-criticality-High" data-criticality="High" onclick="toggleCriticalityFilter('High', this)">High</div>
            <div class="urgency-level Medium" id="filter-criticality-Medium" data-criticality="Medium" onclick="toggleCriticalityFilter('Medium', this)">Medium</div>
            <div class="urgency-level Low" id="filter-criticality-Low" data-criticality="Low" onclick="toggleCriticalityFilter('Low', this)">Low</div>
          </div>

          <div class="provenance">
            <h3>Active Data Sources</h3>
            <ul class="source-list" id="source-list">
              <li style="opacity: 0.5;"><i class="fas fa-circle-notch fa-spin"></i> Loading sources...</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="detail-modal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeDetailModal()">&times;</span>
      <div id="modal-body"></div>
    </div>
  </div>

  <script>
    // Configuration
    const API_BASE = 'http://localhost:8000/api';
    const REFRESH_MS = 60_000;
    
    // Authentication
    function getAuthToken() {
      return localStorage.getItem('auth_token');
    }
    
    function getAuthHeaders() {
      const token = getAuthToken();
      const headers = {
        'Content-Type': 'application/json'
      };
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      return headers;
    }
    
    function logout() {
      localStorage.removeItem('auth_token');
      localStorage.removeItem('user');
      window.location.href = 'login.html';
    }
    
    // Check authentication on page load
    if (!getAuthToken()) {
      window.location.href = 'login.html';
    }

    // Utilities
    function getTimeAgo(date){
      const d = new Date(date); const diff = Date.now() - d.getTime();
      const m = Math.floor(diff/60000); if (m<60) return `${m}m ago`;
      const h = Math.floor(m/60); if (h<24) return `${h}h ago`;
      return `${Math.floor(h/24)}d ago`;
    }
    
    function htmlEscape(str=""){
      return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function iconForSource(src){
      const s = (src||"").toLowerCase();
      if (s.includes("nws")) return `<i class="fas fa-bolt"></i>`;
      if (s.includes("earthquakes") || s.includes("usgs_earthquakes")) return `<i class="fas fa-mountain-sun"></i>`;
      if (s.includes("nwis") || s.includes("usgs_nwis")) return `<i class="fas fa-water"></i>`;
      if (s.includes("firms") || s.includes("eonet") || s.includes("nasa")) return `<i class="fas fa-fire"></i>`;
      if (s.includes("wmata")) return `<i class="fas fa-train-subway"></i>`;
      return `<i class="fas fa-circle-info"></i>`;
    }

    function sourceDisplayName(src){
      const s = (src||"").toLowerCase();
      if (s.includes("nws")) return "NWS Weather Alerts";
      if (s.includes("earthquakes") || s.includes("usgs_earthquakes")) return "USGS Earthquakes";
      if (s.includes("nwis") || s.includes("usgs_nwis")) return "USGS NWIS (Rivers)";
      if (s.includes("firms") || s.includes("nasa_firms")) return "NASA FIRMS (Fires)";
      if (s.includes("wmata")) return "WMATA Transit";
      return src;
    }

    // API Calls
    async function fetchAlerts(){
      // Fetch all alerts including irrelevant ones (we'll sort them to bottom)
      // Using limit=100 (API max) and show_irrelevant=true to get all alerts
      const response = await fetch(`${API_BASE}/alerts?limit=100&show_irrelevant=true`, {
        headers: getAuthHeaders()
      });
      if (!response.ok) {
        if (response.status === 401) {
          logout();
          return;
        }
        throw new Error('Failed to fetch alerts');
      }
      return response.json();
    }

    async function fetchAlertDetail(id){
      const response = await fetch(`${API_BASE}/alerts/${id}`, {
        headers: getAuthHeaders()
      });
      if (!response.ok) {
        if (response.status === 401) {
          logout();
          return;
        }
        throw new Error('Failed to fetch alert detail');
      }
      return response.json();
    }

    async function markNotRelevant(id){
      const response = await fetch(`${API_BASE}/alerts/${id}/not-relevant`, {
        method: 'POST',
        headers: getAuthHeaders()
      });
      if (!response.ok) {
        if (response.status === 401) {
          logout();
          return;
        }
        throw new Error('Failed to mark as not relevant');
      }
      return response.json();
    }

    async function acknowledgeAlert(id, note){
      const response = await fetch(`${API_BASE}/alerts/${id}/acknowledge`, {
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify({note: note || null})
      });
      if (!response.ok) {
        if (response.status === 401) {
          logout();
          return;
        }
        throw new Error('Failed to acknowledge alert');
      }
      return response.json();
    }

    // Handlers
    async function handleNotRelevant(alertId, button){
      try {
        button.disabled = true;
        await markNotRelevant(alertId);
        button.textContent = 'Moved';
        // Reload immediately to move to bottom
        await loadAlerts();
      } catch(e) {
        console.error(e);
        alert('Failed to mark as not relevant');
        button.disabled = false;
      }
    }

    function viewOnMap(alertId){
      window.location.href = `map.html#alert-${alertId}`;
    }

    async function showAlertDetail(alertId){
      try {
        const alert = await fetchAlertDetail(alertId);
        renderDetailModal(alert);
      } catch(e) {
        console.error(e);
        alert('Failed to load alert details');
      }
    }
    
    // Handle hash-based navigation (from map)
    function handleHashNavigation() {
      const hash = window.location.hash;
      if (!hash || !hash.startsWith('#alert-')) return;
      
      const alertId = hash.replace('#alert-', '');
      const alertElement = document.getElementById(`alert-${alertId}`);
      
      if (alertElement) {
        // Scroll to the alert
        alertElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Highlight it temporarily
        alertElement.classList.add('highlighted');
        setTimeout(() => {
          alertElement.classList.remove('highlighted');
        }, 3000);
      }
    }

    function renderDetailModal(alert){
      const criticality = alert.latest_classification?.criticality || 'Unknown';
      const rationale = alert.latest_classification?.rationale || 'No classification available';
      const isAcknowledged = alert.user_actions?.some(a => a.action === 'acknowledged');
      
      const modalHTML = `
        <div class="modal-header">
          <div class="modal-title">${htmlEscape(alert.title)}</div>
          <div class="urgency-badge ${criticality}">${criticality}</div>
          ${isAcknowledged ? '<span class="acknowledged-badge">✓ Acknowledged</span>' : ''}
        </div>
        <div class="modal-body">
          <div class="detail-section">
            <h3>Overview</h3>
            <p>${htmlEscape(alert.summary || 'No summary available')}</p>
          </div>
          
          <div class="detail-section">
            <h3>Details</h3>
            <div class="detail-grid">
              <div class="detail-item"><label>Source</label><value>${htmlEscape(alert.source)}</value></div>
              <div class="detail-item"><label>Event Type</label><value>${htmlEscape(alert.event_type || 'N/A')}</value></div>
              <div class="detail-item"><label>Severity</label><value>${htmlEscape(alert.severity || 'N/A')}</value></div>
              <div class="detail-item"><label>Urgency</label><value>${htmlEscape(alert.urgency || 'N/A')}</value></div>
              <div class="detail-item"><label>Area</label><value>${htmlEscape(alert.area || 'N/A')}</value></div>
              <div class="detail-item"><label>Effective</label><value>${new Date(alert.effective_at).toLocaleString()}</value></div>
            </div>
          </div>

          <div class="detail-section">
            <h3>AI Classification</h3>
            <p><strong>Criticality:</strong> ${criticality}</p>
            <p><strong>Rationale:</strong> ${htmlEscape(rationale)}</p>
            <p style="opacity:0.7;font-size:0.85rem;">Model: ${htmlEscape(alert.latest_classification?.model_version || 'N/A')}</p>
          </div>

          ${alert.url ? `
            <div class="detail-section">
              <h3>Source Link</h3>
              <p><a href="${alert.url}" target="_blank" style="color:#ffd76a;">${alert.url}</a></p>
            </div>
          ` : ''}

          ${!isAcknowledged ? `
            <div class="acknowledge-form">
              <h3 style="margin-bottom:10px;color:#ffd76a;">Acknowledge Alert</h3>
              <textarea id="ack-note" placeholder="Optional note (e.g., actions taken, assigned to...)"></textarea>
              <button onclick="handleAcknowledge(${alert.id})">Acknowledge Alert</button>
            </div>
          ` : `
            <div class="detail-section">
              <h3>Acknowledgment</h3>
              ${alert.user_actions.filter(a => a.action === 'acknowledged').map(a => `
                <p>Acknowledged ${getTimeAgo(a.created_at)}</p>
                ${a.note ? `<p style="font-style:italic;opacity:0.8;">"${htmlEscape(a.note)}"</p>` : ''}
              `).join('')}
            </div>
          `}
        </div>
      `;
      
      document.getElementById('modal-body').innerHTML = modalHTML;
      document.getElementById('detail-modal').classList.add('active');
    }

    async function handleAcknowledge(alertId){
      const note = document.getElementById('ack-note')?.value;
      try {
        await acknowledgeAlert(alertId, note);
        closeDetailModal();
        loadAlerts();
        alert('Alert acknowledged successfully');
      } catch(e) {
        console.error(e);
        alert('Failed to acknowledge alert');
      }
    }

    function closeDetailModal(){
      document.getElementById('detail-modal').classList.remove('active');
    }

    // Close modal on outside click
    window.onclick = function(event) {
      const modal = document.getElementById('detail-modal');
      if (event.target == modal) {
        closeDetailModal();
      }
    }

    // Render alerts
    function renderAlerts(data){
      const container = document.getElementById('alerts-container');
      
      if (!data.alerts || data.alerts.length === 0){
        container.innerHTML = `
          <div class="no-alerts">
            <h3>No Active Alerts</h3>
            <p>All systems are currently normal for the selected area.</p>
          </div>`;
        return;
      }

      // Sort alerts: relevant first, then irrelevant at bottom
      const sortedAlerts = [...data.alerts].sort((a, b) => {
        const aIsIrrelevant = a.user_actions?.some(action => action.action === 'irrelevant');
        const bIsIrrelevant = b.user_actions?.some(action => action.action === 'irrelevant');
        if (aIsIrrelevant && !bIsIrrelevant) return 1;
        if (!aIsIrrelevant && bIsIrrelevant) return -1;
        return new Date(b.effective_at) - new Date(a.effective_at);
      });

      // Apply filters (source and criticality)
      let filtered = sortedAlerts;
      
      // Apply source filter
      const selectedSources = window.__selectedSources || [];
      if (selectedSources.length > 0) {
        filtered = filtered.filter(a => a.source && selectedSources.includes(a.source));
      }
      
      // Apply criticality filter
      const selectedCriticalities = window.__selectedCriticalities || [];
      if (selectedCriticalities.length > 0) {
        filtered = filtered.filter(a => {
          const crit = a.latest_classification?.criticality || 'Low';
          return selectedCriticalities.includes(crit);
        });
      }

      container.innerHTML = filtered.map(alert => {
        const isIrrelevant = alert.user_actions?.some(a => a.action === 'irrelevant');
        const criticality = alert.latest_classification?.criticality || 'Low';
        const timeAgo = getTimeAgo(alert.effective_at);
        const location = alert.area || "Local";
        const srcIcon = iconForSource(alert.source);
        const link = alert.url ? `<a href="${alert.url}" target="_blank" rel="noopener">source</a>` : ``;
        const isAcknowledged = alert.user_actions?.some(a => a.action === 'acknowledged');
        
        // Check if this alert should be highlighted (from hash)
        const hash = window.location.hash;
        const shouldHighlight = hash === `#alert-${alert.id}`;
        
        return `
          <div class="alert-item ${criticality} ${shouldHighlight ? 'highlighted' : ''}" id="alert-${alert.id}" style="${isIrrelevant ? 'opacity: 0.5; order: 999;' : ''}">
            <div class="alert-header">
              <div>
                <div class="urgency-badge ${criticality}">${criticality}</div>
                ${isAcknowledged ? '<span class="acknowledged-badge">✓ Acknowledged</span>' : ''}
                ${isIrrelevant ? '<span class="acknowledged-badge" style="background: rgba(220,53,69,0.3); color: #ff6b6b;">Marked Irrelevant</span>' : ''}
                <div class="time-location">${timeAgo} • ${htmlEscape(location)}</div>
              </div>
            </div>
            <div class="alert-title">${htmlEscape(alert.title)}</div>
            ${alert.summary ? `<div class="alert-summary">${htmlEscape(alert.summary.substring(0, 200))}${alert.summary.length > 200 ? '...' : ''}</div>` : ``}
            <div class="source-chip">${srcIcon} ${htmlEscape(alert.source)} ${link ? "• " + link : ""}</div>
            <div class="action-section">
              <div class="action-buttons">
                <button class="action-btn view-more" onclick="showAlertDetail(${alert.id})">Know More</button>
                ${alert.latitude != null && alert.longitude != null ? `<button class="action-btn view-map" onclick="viewOnMap(${alert.id})">View on Map</button>` : ''}
                ${!isIrrelevant ? `<button class="action-btn not-relevant" onclick="handleNotRelevant(${alert.id}, this)">Irrelevant</button>` : ''}
              </div>
            </div>
          </div>`;
      }).join("");
    }

    // Toggle source filter
    function toggleSourceFilter(source, element) {
      if (!window.__selectedSources) {
        window.__selectedSources = [];
      }
      
      const index = window.__selectedSources.indexOf(source);
      if (index > -1) {
        // Remove filter
        window.__selectedSources.splice(index, 1);
        element.classList.remove('active');
      } else {
        // Add filter
        window.__selectedSources.push(source);
        element.classList.add('active');
      }
      
      // Re-render alerts
      if (window.__lastData) {
        renderAlerts(window.__lastData);
      }
    }
    
    // Toggle criticality filter
    function toggleCriticalityFilter(criticality, element) {
      if (!window.__selectedCriticalities) {
        window.__selectedCriticalities = [];
      }
      
      const index = window.__selectedCriticalities.indexOf(criticality);
      if (index > -1) {
        // Remove filter
        window.__selectedCriticalities.splice(index, 1);
        element.classList.remove('active');
      } else {
        // Add filter
        window.__selectedCriticalities.push(criticality);
        element.classList.add('active');
      }
      
      // Re-render alerts
      if (window.__lastData) {
        renderAlerts(window.__lastData);
      }
    }

    // Update active sources list
    function updateSourcesList(alerts){
      const sourceList = document.getElementById('source-list');
      if (!alerts || alerts.length === 0) {
        sourceList.innerHTML = '<li style="opacity: 0.7;"><i class="fas fa-info-circle"></i> No active sources</li>';
        return;
      }

      // Get unique sources from alerts
      const sources = new Set();
      alerts.forEach(alert => {
        if (alert.source) {
          sources.add(alert.source);
        }
      });

      if (sources.size === 0) {
        sourceList.innerHTML = '<li style="opacity: 0.7;"><i class="fas fa-info-circle"></i> No active sources</li>';
        return;
      }

      // Sort sources alphabetically
      const sortedSources = Array.from(sources).sort();
      
      sourceList.innerHTML = sortedSources.map(source => {
        const isActive = window.__selectedSources && window.__selectedSources.includes(source);
        return `<li onclick="toggleSourceFilter('${htmlEscape(source)}', this)" data-source="${htmlEscape(source)}" class="${isActive ? 'active' : ''}">${iconForSource(source)} ${htmlEscape(sourceDisplayName(source))}</li>`;
      }).join('');
    }

    // Main load function
    async function loadAlerts(){
      try {
        const data = await fetchAlerts();
        window.__lastData = data; // cache for filters
        renderAlerts(data);
        updateSourcesList(data.alerts);
        document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
      } catch(e) {
        console.error('Error loading alerts:', e);
        document.getElementById('alerts-container').innerHTML = `
          <div class="no-alerts">
            <h3>Connection Error</h3>
            <p>Unable to fetch current alerts. Please ensure the API server is running.</p>
          </div>`;
        document.getElementById('source-list').innerHTML = '<li style="opacity: 0.7; color: #ff6b6b;"><i class="fas fa-exclamation-triangle"></i> Connection error</li>';
      }
    }

    // Display user info
    function displayUserInfo() {
      const userStr = localStorage.getItem('user');
      if (userStr) {
        try {
          const user = JSON.parse(userStr);
          const displayName = user.full_name || user.username || user.email;
          document.getElementById('user-display').innerHTML = `<i class="fas fa-user"></i> ${htmlEscape(displayName)}`;
        } catch (e) {
          document.getElementById('user-display').textContent = 'User';
        }
      } else {
        document.getElementById('user-display').textContent = 'User';
      }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      displayUserInfo();
      loadAlerts();
      setInterval(loadAlerts, REFRESH_MS);
      
      // Handle hash navigation after initial load
      setTimeout(() => {
        handleHashNavigation();
      }, 1000);
      
      // Also handle hash changes (e.g., if user navigates back)
      window.addEventListener('hashchange', () => {
        setTimeout(() => {
          handleHashNavigation();
        }, 100);
      });
    });
  </script>
</body>
</html>

